<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ventas Pro - Flow Editor</title>
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/drawflow/dist/drawflow.min.css">
    <link rel="stylesheet" href="flow-editor.css">
    <style>
        /* Estilos preservados y optimizados */
        * { font-family: 'Montserrat', sans-serif !important; }
        .flow-card {
            background: #1a1b26; padding: 10px; border-radius: 8px; margin-bottom: 8px;
            display: flex; justify-content: space-between; align-items: center; color: white;
            border: 1px solid #333; transition: 0.3s;
        }
        .flow-card button { background: #2563eb; color: white; border: none; padding: 5px 10px; border-radius: 4px; }
        .btn-header-custom { border-radius: 5px; cursor: pointer; font-weight: 600; padding: 10px; border: none; }
    </style>
</head>
<body>

    <div class="editor-header">
        <div class="logo-container">
            <img src="https://www.websrapidas.com/wp-content/uploads/2026/02/logo-ventas-pro-png.png" class="logo" alt="Ventas Pro">
        </div>

        <div class="header-buttons">
            <button onclick="forceLoadNemo()" class="btn btn-primary" style="font-family: 'Montserrat';">
   üöÄ Cargar Nemo Directo
</button>
            <button class="btn-trigger" onclick="addTriggerNode()"><i class="fa-solid fa-bolt"></i> TRIGGER</button>
            <button class="btn-message" onclick="addMessageNode()"><i class="fa-solid fa-comment"></i> MENSAJE</button>
            <button class="btn-ia" onclick="addIANode()"><i class="fa-solid fa-robot"></i> IA CHAT</button>
            <button class="btn-list" onclick="addListNode()"><i class="fa-solid fa-list-ul"></i> LISTA</button>
            <button class="btn-media" onclick="addMediaNode()"><i class="fa-solid fa-image"></i> IMAGEN</button>
            
            <button class="btn-payment btn-header-custom" onclick="addPaymentValidationNode()" style="background:#2ecc71; color:white;">
                <i class="fa-solid fa-money-bill-1-wave"></i> VALIDAR PAGO
            </button>

            <button class="btn-notify btn-header-custom" onclick="addNotifyNode()" style="background: #ff9800; color: white;">
                <i class="fa-solid fa-bell"></i> NOTIFICAR
            </button>

            <button class="btn-save" onclick="saveFlow()"><i class="fa-solid fa-floppy-disk"></i> GUARDAR</button>
            
            <button onclick="downloadFlow()" class="btn-header-custom" style="background: #25d366; color: white;">
                <i class="fa-solid fa-download"></i> Descargar
            </button>

            <button onclick="document.getElementById('importInput').click()" class="btn-import btn-header-custom" style="background: #34b7f1; color: white;">
                <i class="fa-solid fa-upload"></i> Importar/Cargar
            </button>
            
            <input type="text" id="flow_name" placeholder="Nombre del flujo" style="border-radius:5px; padding:5px; background:#1a1b26; color:white; border:1px solid #444; width: 140px;">
            
            <button class="btn-import" onclick="openFlowsModal()"><i class="fa-solid fa-folder-open"></i> MIS FLUJOS</button>
        </div>
    </div>

    <input type="file" id="importInput" style="display: none;" accept=".json" onchange="handleImport(event)">

    <div id="drawflow"></div>

    <div id="flowsModal" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.85); z-index:2000; justify-content:center; align-items:center;">
        <div style="background:#161c2d; padding:25px; border-radius:15px; width:450px; border:1px solid #2563eb; box-shadow: 0 10px 30px rgba(0,0,0,0.5);">
            <h3 style="color:white; font-weight:700; margin-bottom:20px; display:flex; align-items:center; gap:10px;">
                <i class="fa-solid fa-folder-open" style="color:#2563eb;"></i> Mis Flujos üìÅ
            </h3>
            <div id="flowsList" style="margin: 20px 0; max-height:350px; overflow-y:auto; padding-right:5px;">
                </div>
            <button onclick="closeFlowsModal()" class="btn btn-danger w-100" style="font-weight:600; border-radius:8px;">
                <i class="fa-solid fa-xmark"></i> CERRAR
            </button>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/drawflow/dist/drawflow.min.js"></script>
    <script src="flow-editor.js"></script>

    <script>
        // Funci√≥n de descarga
        function downloadFlow() {
            window.location.href = "/api/download-flow";
        }

        // 1. Cerrar Modal
        window.closeFlowsModal = function() {
            document.getElementById('flowsModal').style.display = 'none';
        };

        // 2. Cargar un flujo espec√≠fico desde el servidor
        window.loadSpecificFlow = async function(id) {
            try {
                const res = await fetch(`/api/get-flow-by-id/${id}`);
                const responseData = await res.json();
                
                if (typeof editor !== 'undefined') {
                    editor.clear();

                    let raw = responseData.data ? responseData.data : responseData;
                    if (typeof raw === 'string') raw = JSON.parse(raw);

                    let nodesFound = {};
                    if (raw.drawflow && raw.drawflow.Home && raw.drawflow.Home.data) {
                        nodesFound = raw.drawflow.Home.data;
                    } else if (raw.drawflow && raw.drawflow.Home) {
                        nodesFound = raw.drawflow.Home;
                    } else if (raw.Home && raw.Home.data) {
                        nodesFound = raw.Home.data;
                    } else {
                        nodesFound = raw;
                    }

                    const cleanNodes = {};
                    if (nodesFound && typeof nodesFound === 'object') {
                        Object.keys(nodesFound).forEach(key => {
                            if (nodesFound[key] && typeof nodesFound[key] === 'object') {
                                cleanNodes[key] = nodesFound[key];
                            }
                        });
                    }

                    const finalData = {
                        "drawflow": { "Home": { "data": cleanNodes } }
                    };

                    if (Object.keys(cleanNodes).length === 0) {
                        alert("‚ö†Ô∏è El flujo seleccionado est√° vac√≠o o da√±ado.");
                        return;
                    }

                    editor.import(finalData);
                    setTimeout(() => { editor.zoom_reset(); }, 200);
                    closeFlowsModal();
                }
            } catch (e) {
                console.error("Error cr√≠tico en la carga:", e);
                alert("‚ùå Error de formato: El JSON de este flujo es inv√°lido.");
            }
        };

        // 3. Manejar Importaci√≥n manual
        async function handleImport(event) {
            const file = event.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = async (e) => {
                try {
                    const flowData = JSON.parse(e.target.result);
                    if (typeof editor !== 'undefined') {
                        editor.clear(); 
                        editor.import(flowData);
                        editor.zoom_reset();
                        
                        await fetch('/api/import-flow', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify(flowData)
                        });
                        alert("‚úÖ Flujo importado correctamente üöÄ");
                    }
                } catch (err) {
                    alert("‚ùå El archivo no es un JSON v√°lido.");
                }
            };
            reader.readAsText(file);
        }

        // 4. Listener para mensajes desde app.js
        window.addEventListener('message', function(e) {
            if (e.data.type === 'IMPORT_CLEAN' || e.data.type === 'LOAD_FLOW') {
                const flowData = e.data.data;
                if (typeof editor !== 'undefined') {
                    editor.clear();
                    const finalData = flowData.drawflow ? flowData : (flowData.data || flowData);
                    editor.import(finalData); 
                    editor.zoom_reset();
                }
            }
        });

        // 5. Funci√≥n para abrir el modal
        window.openFlowsModal = async function() {
            const modal = document.getElementById('flowsModal');
            const list = document.getElementById('flowsList');
            modal.style.display = 'flex';
            list.innerHTML = '<p style="color:white; text-align:center;">Cargando flujos...</p>';
            
            try {
                const res = await fetch('/api/get-flows');
                const flows = await res.json();
                list.innerHTML = "";
                
                if (!flows || flows.length === 0) {
                    list.innerHTML = '<p style="color:#666; text-align:center;">No hay flujos guardados.</p>';
                    return;
                }

                flows.forEach(f => {
                    const div = document.createElement('div');
                    div.className = "flow-card";
                    div.innerHTML = `
                        <div style="display:flex; flex-direction:column;">
                            <span style="font-weight:600; font-size:14px;">${f.name || 'Sin nombre'}</span>
                            <small style="color:#666; font-size:10px;">ID: ${f.id.substring(0,8)}...</small>
                        </div>
                        <button onclick="loadSpecificFlow('${f.id}')">ABRIR</button>
                    `;
                    list.appendChild(div);
                });
            } catch (e) {
                list.innerHTML = '<p style="color:#ff4b2b; text-align:center;">Error al conectar con el servidor.</p>';
            }
        };
    </script>
</body>
</html>