let currentChat=null;
let unreadCounts = {}; 

const chatList=document.getElementById("chat-list");
const messagesContainer=document.getElementById("messages");
const chatContent=document.getElementById("chatContent");
const chatListContainer=document.getElementById("chatListContainer");

/* ENTER ENV√çA */
document.getElementById("message-input").addEventListener("keypress",e=>{
if(e.key==="Enter"){e.preventDefault();sendMessage();}
});

/* EMOJI */
const picker=new EmojiMart.Picker({onEmojiSelect:e=>{
document.getElementById("message-input").value+=e.native;
}});
document.getElementById("emoji-picker-container").appendChild(picker);

document.getElementById("emoji-trigger").onclick=()=>{
const c=document.getElementById("emoji-picker-container");
c.style.display=c.style.display==="none"?"block":"none";
};

/* WEBSOCKET */
const ws=new WebSocket(
location.protocol==="https:"?"wss://"+location.host:"ws://"+location.host
);

ws.onmessage=(event)=>{
const data=JSON.parse(event.data);
if(data.type==="new_message"){
const chatId = data.message.chatId;
if(chatId===currentChat){ renderMessage(data.message); } 
else { unreadCounts[chatId] = (unreadCounts[chatId] || 0) + 1; }
loadChats();
}
};

/* CARGAR CHATS */
async function loadChats(){
const res=await fetch("/chats");
const chats=await res.json();
chatList.innerHTML="";
chats.forEach(chat=>{
const div=document.createElement("div");
div.className="chat-item";
if(unreadCounts[chat._id]) div.classList.add("unread");
div.innerHTML=`
<div>${chat._id}</div>
<small>${chat.lastMessage||""}</small>
${unreadCounts[chat._id] ? `<span class="badge">${unreadCounts[chat._id]}</span>` : ""}
`;
div.onclick=()=>openChat(chat._id);
chatList.appendChild(div);
});
}

/* ABRIR CHAT */
async function openChat(chatId){
currentChat=chatId;
delete unreadCounts[chatId];
document.getElementById("header-name").innerText=chatId;
messagesContainer.innerHTML="";
if(window.innerWidth<=768){
chatListContainer.style.display="none";
chatContent.classList.add("active-mobile");
}
const res=await fetch("/messages/"+chatId);
const msgs=await res.json();
msgs.forEach(renderMessage);
loadChats();
}

function goBackMobile(){
chatContent.classList.remove("active-mobile");
chatListContainer.style.display="flex";
}

function renderMessage(msg){
const div=document.createElement("div");
div.className="msg-bubble "+(msg.from==="me"?"msg-sent":"msg-received");
if(msg.media){
const img=document.createElement("img");
img.src=msg.media;
img.className="msg-image";
img.onerror=function(){this.style.display="none";};
div.appendChild(img);
}
if(msg.text){
const text=document.createElement("div");
text.innerText=msg.text;
div.appendChild(text);
}
const time=document.createElement("div");
time.className="msg-time";
time.style = "font-size:10px; opacity:0.6; margin-top:5px; text-align:right";
const now=msg.timestamp?new Date(msg.timestamp):new Date();
time.innerText=now.toLocaleTimeString([], {hour:'2-digit',minute:'2-digit'});
div.appendChild(time);
messagesContainer.appendChild(div);
messagesContainer.scrollTop=messagesContainer.scrollHeight;
}

async function sendMessage(){
if(!currentChat)return;
const input=document.getElementById("message-input");
const text=input.value.trim();
if(!text)return;
await fetch("/send-message",{
method:"POST",
headers:{"Content-Type":"application/json"},
body:JSON.stringify({to:currentChat,text})
});
input.value="";
}

/* --- TUS FUNCIONES DE MEDIA --- */
let selectedFiles=[];
document.getElementById("file-input").addEventListener("change",(e)=>{
if(!currentChat){alert("Selecciona un chat primero");return;}
selectedFiles=[...e.target.files];
if(selectedFiles.length===0)return;
const container=document.getElementById("preview-container");
container.innerHTML="";
selectedFiles.forEach(file=>{
const img=document.createElement("img");
img.src=URL.createObjectURL(file);
container.appendChild(img);
});
document.getElementById("image-modal").style.display="flex";
});

function closeModal(){
document.getElementById("image-modal").style.display="none";
document.getElementById("image-comment").value="";
selectedFiles=[];
document.getElementById("file-input").value="";
}

async function confirmSendImages(){
if(!currentChat)return;
for(const file of selectedFiles){
const formData=new FormData();
formData.append("file",file);
formData.append("to",currentChat);
await fetch("/send-media",{method:"POST",body:formData});
}
const comment=document.getElementById("image-comment").value;
if(comment.trim()!==""){
await fetch("/send-message",{
method:"POST",
headers:{"Content-Type":"application/json"},
body:JSON.stringify({to:currentChat,text:comment})
});
}
closeModal();
}

/* --- NUEVAS FUNCIONES --- */
async function searchMessages() {
    const query = document.getElementById("global-search").value.toLowerCase();
    const overlay = document.getElementById("search-results-overlay");
    const resultsList = document.getElementById("search-results-list");
    if (query.length < 2) { overlay.style.display = "none"; return; }
    const res = await fetch("/search?q=" + query);
    const results = await res.json();
    resultsList.innerHTML = "";
    overlay.style.display = "flex";
    results.forEach(res => {
        const div = document.createElement("div");
        div.className = "search-result-item";
        div.innerHTML = `<div style="font-size:11px; color:var(--blue); font-weight:700">${res.chatId}</div>
                         <div style="font-size:13px">...${res.text.replace(new RegExp(query, 'gi'), m => `<span class="match">${m}</span>`)}...</div>`;
        div.onclick = () => { openChat(res.chatId); closeSearch(); };
        resultsList.appendChild(div);
    });
}

function closeSearch() {
    document.getElementById("search-results-overlay").style.display = "none";
    document.getElementById("global-search").value = "";
}

async function deleteCurrentChat() {
    if (!currentChat) return;
    if (confirm("üóëÔ∏è ¬øEliminar esta conversaci√≥n del servidor?")) {
        const res = await fetch(`/chats/${currentChat}`, { method: "DELETE" });
        if (res.ok) {
            currentChat = null;
            document.getElementById("header-name").innerText = "Selecciona un chat";
            messagesContainer.innerHTML = "";
            loadChats();
        }
    }
}

loadChats();