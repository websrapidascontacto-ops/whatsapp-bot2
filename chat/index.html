<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<title>CRM Webs RÃ¡pidas - Premium</title>
<link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;600;700&display=swap" rel="stylesheet">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
<script src="https://cdn.jsdelivr.net/npm/emoji-mart@latest/dist/browser.js"></script>
<style>
/* Estilos Montserrat intactos */
*{box-sizing:border-box}
body{margin:0;padding:0;height:100vh;font-family:'Montserrat',sans-serif;background:#f0f2f5;color:#1c1e21;display:flex}
.sidebar-redes{width:75px;background:#fff;border-right:1px solid #e4e6eb;display:flex;flex-direction:column;align-items:center;padding-top:25px}
.chat-list-container{width:360px;background:#fff;border-right:1px solid #e4e6eb;display:flex;flex-direction:column}
.chat-list{flex:1;overflow-y:auto}
.chat-item{padding:15px 20px;display:flex;align-items:center;gap:15px;cursor:pointer;border-bottom:1px solid #f0f2f5;position:relative}
.chat-item.active{background:#e7f3ff;border-left:4px solid #0084ff}
.chat-content{flex:1;display:flex;flex-direction:column;background:#fff}
.messages-area{flex:1;padding:25px;overflow-y:auto;background:#f9f9fb;display:flex;flex-direction:column;gap:10px}
.msg-bubble{max-width:65%;padding:6px;font-size:14px;border-radius:12px;display:flex;flex-direction:column}
.msg-received{background:#fff;align-self:flex-start;border-bottom-left-radius:4px}
.msg-sent{background:#0084ff;color:#fff;align-self:flex-end;border-bottom-right-radius:4px}
.msg-image{width:100%;max-width:320px;border-radius:8px;cursor:pointer}
.input-area{padding:15px 25px;display:flex;align-items:center;gap:15px;border-top:1px solid #e4e6eb}
.input-area input[type="text"]{flex:1;background:#f0f2f5;border:none;padding:12px 18px;border-radius:20px;outline:none}
.send-btn{background:#0084ff;color:#fff;width:40px;height:40px;border-radius:50%;display:flex;align-items:center;justify-content:center;cursor:pointer}
#emoji-picker-box{position:absolute;bottom:80px;left:25px;display:none;z-index:100}
</style>
</head>
<body>
<div class="sidebar-redes">
    <img src="https://upload.wikimedia.org/wikipedia/commons/6/6b/WhatsApp.svg" width="35" style="margin-bottom:30px">
    <div style="margin-top:auto;padding-bottom:25px;font-weight:700;font-size:11px;color:#8a8d91">S/380</div>
</div>
<div class="chat-list-container">
    <div style="padding:25px;font-weight:700;font-size:20px">Mensajes</div>
    <div id="chat-list" class="chat-list"></div>
</div>
<div class="chat-content">
    <div class="top-bar" style="padding:12px 25px;border-bottom:1px solid #e4e6eb;display:flex;align-items:center;gap:15px">
        <img id="header-pic" src="https://via.placeholder.com/42" style="width:42px;height:42px;border-radius:50%">
        <div id="header-name" style="font-weight:700">Selecciona un chat</div>
    </div>
    <div id="messages" class="messages-area"></div>
    <div class="input-area">
        <i class="fa-regular fa-face-smile" id="emoji-trigger" style="cursor:pointer;font-size:22px"></i>
        <label for="file-input"><i class="fa-solid fa-plus" style="cursor:pointer;font-size:22px"></i></label>
        <input type="file" id="file-input" style="display:none" accept="image/*" multiple>
        <input type="text" id="message-input" placeholder="Escribe un mensaje...">
        <div class="send-btn" onclick="sendMessage()"><i class="fa-solid fa-paper-plane"></i></div>
        <div id="emoji-picker-box"></div>
    </div>
</div>

<script>
let currentChat = null; let chats = {};
const ws = new WebSocket(`${window.location.protocol === "https:" ? "wss:" : "ws:"}//${window.location.host}`);

ws.onmessage = (event) => {
  const msg = JSON.parse(event.data);
  if(msg.type === "incoming"){
    createOrUpdateChat(msg.data);
    if(currentChat === msg.data.from) appendMessage("received", msg.data.text, msg.data.mediaUrl);
  } else if(msg.type === "sent"){
    if(currentChat === msg.data.to) appendMessage("sent", msg.data.text, msg.data.mediaUrl);
  }
};

function createOrUpdateChat(data){
  const id = data.from || data.chatId;
  if(!chats[id]){
    chats[id] = { name: data.pushname || id, unread: 0 };
    const div = document.createElement("div");
    div.className = "chat-item"; div.id = "chat-"+id;
    div.innerHTML = `<div style="flex:1"><b>${chats[id].name}</b><br><small>${data.text || "ðŸ“· Imagen"}</small></div>`;
    div.onclick = () => openChat(id);
    document.getElementById("chat-list").prepend(div);
  }
}

async function openChat(id){
  currentChat = id; document.getElementById("header-name").innerText = chats[id].name;
  document.querySelectorAll('.chat-item').forEach(el => el.classList.remove('active'));
  document.getElementById("chat-"+id).classList.add('active');
  const res = await fetch(`/chat/messages/${id}`);
  const msgs = await res.json();
  document.getElementById("messages").innerHTML = "";
  msgs.forEach(m => appendMessage(m.from === "me" ? "sent" : "received", m.text, m.mediaUrl));
}

function appendMessage(type, text, mediaUrl){
  const div = document.createElement("div");
  div.className