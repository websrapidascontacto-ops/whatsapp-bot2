<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<title>CRM WhatsApp</title>

<style>
body {
    margin: 0;
    font-family: Arial, sans-serif;
    display: flex;
    height: 100vh;
}

.sidebar {
    width: 30%;
    border-right: 1px solid #ddd;
    overflow-y: auto;
}

.chat-item {
    padding: 15px;
    cursor: pointer;
    border-bottom: 1px solid #eee;
}

.chat-item:hover {
    background: #f5f5f5;
}

.chat-item.active {
    background: #e9f3ff;
}

.chat-container {
    width: 70%;
    display: flex;
    flex-direction: column;
}

.header {
    padding: 15px;
    border-bottom: 1px solid #ddd;
    font-weight: bold;
}

.messages {
    flex: 1;
    padding: 15px;
    overflow-y: auto;
    display: flex;
    flex-direction: column;
}

.message {
    max-width: 60%;
    padding: 10px;
    border-radius: 10px;
    margin-bottom: 10px;
}

.sent {
    align-self: flex-end;
    background: #DCF8C6;
}

.received {
    align-self: flex-start;
    background: #f1f1f1;
}

.input-area {
    display: flex;
    padding: 10px;
    border-top: 1px solid #ddd;
}

.input-area input {
    flex: 1;
    padding: 10px;
}

.input-area button {
    padding: 10px 15px;
    cursor: pointer;
}
</style>
</head>
<body>

<div class="sidebar" id="chat-list"></div>

<div class="chat-container">
    <div class="header" id="header-name">Selecciona un chat</div>
    <div class="messages" id="messages"></div>

    <div class="input-area">
        <input type="text" id="message-input" placeholder="Escribe un mensaje">
        <button onclick="sendMessage()">Enviar</button>
    </div>
</div>

<script>
let currentChat = null;

// ===============================
// CARGAR LISTA DE CHATS
// ===============================
async function loadChats() {
    const res = await fetch("/chat/list");
    const chats = await res.json();

    const chatList = document.getElementById("chat-list");
    chatList.innerHTML = "";

    chats.forEach(chat => {
        const div = document.createElement("div");
        div.className = "chat-item";
        div.id = "chat-" + chat._id;
        div.innerText = chat.pushname || chat._id;
        div.onclick = () => openChat(chat._id);
        chatList.appendChild(div);
    });
}

// ===============================
// ABRIR CHAT
// ===============================
async function openChat(id) {

    currentChat = id;

    document.getElementById("header-name").innerText = id;

    document.querySelectorAll('.chat-item')
        .forEach(el => el.classList.remove('active'));

    document.getElementById("chat-" + id)
        .classList.add('active');

    const res = await fetch(`/chat/messages/${id}`);
    const msgs = await res.json();

    const container = document.getElementById("messages");
    container.innerHTML = "";

    msgs.forEach(m => {

        const isReceived = normalizeNumber(m.from) === normalizeNumber(id);

        appendMessage(
            isReceived ? "received" : "sent",
            m.text,
            m.mediaUrl
        );
    });

    scrollToBottom();
}

// ===============================
// NORMALIZAR NÃšMERO
// ===============================
function normalizeNumber(num) {
    if (!num) return "";
    return num.replace("whatsapp:", "").replace("+", "").trim();
}

// ===============================
// AGREGAR MENSAJE
// ===============================
function appendMessage(type, text, mediaUrl = null) {

    const container = document.getElementById("messages");

    const div = document.createElement("div");
    div.classList.add("message", type);

    if (text) {
        const textNode = document.createElement("div");
        textNode.innerText = text;
        div.appendChild(textNode);
    }

    if (mediaUrl) {
        const img = document.createElement("img");
        img.src = mediaUrl;
        img.style.maxWidth = "200px";
        img.style.marginTop = "5px";
        img.style.borderRadius = "8px";
        div.appendChild(img);
    }

    container.appendChild(div);
}

// ===============================
// ENVIAR MENSAJE
// ===============================
async function sendMessage() {

    const input = document.getElementById("message-input");
    const text = input.value.trim();

    if (!text || !currentChat) return;

    await fetch("/send-message", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({
            to: currentChat,
            text: text
        })
    });

    input.value = "";
}

// ===============================
// WEBSOCKET EN TIEMPO REAL
// ===============================
const socket = new WebSocket(`ws://${location.host}`);

socket.onmessage = function(event) {
    const msg = JSON.parse(event.data);

    if (!currentChat) return;

    if (msg.type === "incoming" && msg.data.chatId === currentChat) {
        appendMessage("received", msg.data.text, msg.data.mediaUrl);
    }

    if (msg.type === "sent" && msg.data.to === currentChat) {
        appendMessage("sent", msg.data.text, msg.data.mediaUrl);
    }

    loadChats();
};

// ===============================
function scrollToBottom() {
    const container = document.getElementById("messages");
    container.scrollTop = container.scrollHeight;
}

// ===============================
loadChats();
</script>

</body>
</html>
