<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>CRM Chat</title>

<style>
body{margin:0;font-family:sans-serif;display:flex;height:100vh}
#chat-list{width:300px;border-right:1px solid #ddd;overflow-y:auto}
.chat-item{padding:10px;cursor:pointer;border-bottom:1px solid #eee;display:flex;gap:10px}
.chat-item.active{background:#f5f5f5}
#chat-area{flex:1;display:flex;flex-direction:column}
#header{padding:15px;border-bottom:1px solid #ddd}
#messages{flex:1;padding:15px;overflow-y:auto;background:#f0f2f5}
.msg-bubble{max-width:60%;padding:10px;margin-bottom:10px;border-radius:10px}
.msg-sent{background:#dcf8c6;margin-left:auto}
.msg-received{background:white}
#input-area{display:flex;padding:10px;border-top:1px solid #ddd}
#message-input{flex:1;padding:8px}
</style>
</head>

<body>

<div id="chat-list"></div>

<div id="chat-area">
<div id="header"><b id="header-name">Selecciona un chat</b></div>
<div id="messages"></div>
<div id="input-area">
<input id="message-input" placeholder="Escribe mensaje">
<button onclick="sendMessage()">Enviar</button>
</div>
</div>

<script>
let currentChat=null;
let chats={};

const ws=new WebSocket(`${location.protocol==="https:"?"wss:":"ws:"}//${location.host}`);

ws.onmessage=(event)=>{
  const msg=JSON.parse(event.data);

  if(msg.type==="sent"){
    if(currentChat===msg.data.to){
      appendMessage("sent",msg.data.text,msg.data.mediaUrl);
    }
  }
};

function createOrUpdateChat(data){
  const id=data.chatId;
  chats[id]={name:id};

  let item=document.getElementById("chat-"+id);

  if(!item){
    item=document.createElement("div");
    item.className="chat-item";
    item.id="chat-"+id;
    item.onclick=()=>openChat(id);
    document.getElementById("chat-list").prepend(item);
  }

  item.innerHTML=`<b>${id}</b><br><small>${data.text||""}</small>`;
}

async function openChat(id){
    currentChat = id;

    document.getElementById("header-name").innerText = chats[id].name;

    document.querySelectorAll('.chat-item')
        .forEach(el => el.classList.remove('active'));

    document.getElementById("chat-" + id)
        .classList.add('active');

    const res = await fetch(`/chat/messages/${id}`);
    const msgs = await res.json();

    const container = document.getElementById("messages");
    container.innerHTML = "";

    msgs.forEach(m => {

        // CAMBIO SOLICITADO (NADA M√ÅS)
        const isReceived = m.from === id;

        appendMessage(
            isReceived ? "received" : "sent",
            m.text,
            m.mediaUrl
        );
    });
}

function appendMessage(type,text,mediaUrl){
  const div=document.createElement("div");
  div.className="msg-bubble "+(type==="sent"?"msg-sent":"msg-received");

  if(text) div.innerHTML+=`<div>${text}</div>`;
  if(mediaUrl) div.innerHTML+=`<img src="${mediaUrl}" width="150">`;

  document.getElementById("messages").appendChild(div);
  document.getElementById("messages").scrollTop=
  document.getElementById("messages").scrollHeight;
}

async function sendMessage(){
  const input=document.getElementById("message-input");
  const text=input.value.trim();
  if(!text||!currentChat)return;

  input.value="";

  await fetch("/send-message",{
    method:"POST",
    headers:{"Content-Type":"application/json"},
    body:JSON.stringify({to:currentChat,text})
  });
}

window.onload=async()=>{
  const res=await fetch("/chat/list");
  const list=await res.json();
  list.reverse().forEach(c=>createOrUpdateChat(c));
};

document.getElementById("message-input")
.addEventListener("keypress",(e)=>{
  if(e.key==='Enter')sendMessage()
});
</script>

</body>
</html>
