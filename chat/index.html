<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>CRM Webs RÃ¡pidas - Premium</title>
<link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;600;700&display=swap" rel="stylesheet">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
<script src="https://cdn.jsdelivr.net/npm/emoji-mart@latest/dist/browser.js"></script>

<style>
*{box-sizing:border-box}

body{
    margin:0;
    padding:0;
    height:100vh;
    font-family:'Montserrat',sans-serif;
    background:linear-gradient(135deg,#0f172a,#1e293b);
    color:#1e293b;
    display:flex;
    overflow:hidden;
}

/* ===== SIDEBAR REDES ===== */
.sidebar-redes{
    width:85px;
    background:rgba(255,255,255,0.05);
    backdrop-filter:blur(20px);
    border-right:1px solid rgba(255,255,255,0.08);
    display:flex;
    flex-direction:column;
    align-items:center;
    padding-top:30px;
}

.red-icon{
    width:45px;
    height:45px;
    margin-bottom:30px;
    cursor:pointer;
    display:flex;
    align-items:center;
    justify-content:center;
    border-radius:14px;
    transition:all .3s ease;
}

.red-icon:hover{
    background:rgba(255,255,255,0.1);
    transform:translateY(-3px);
}

.red-icon img{
    width:26px;
    height:26px;
}

/* ===== LISTA DE CHATS ===== */
.chat-list-container{
    width:360px;
    background:#ffffff;
    border-right:1px solid #e5e7eb;
    display:flex;
    flex-direction:column;
}

.list-header{
    padding:28px;
    font-weight:700;
    font-size:22px;
    background:#ffffff;
    border-bottom:1px solid #f1f5f9;
}

.chat-list{
    flex:1;
    overflow-y:auto;
}

.chat-item{
    padding:18px 22px;
    display:flex;
    align-items:center;
    gap:15px;
    cursor:pointer;
    transition:all .25s ease;
    border-bottom:1px solid #f8fafc;
}

.chat-item:hover{
    background:#f8fafc;
}

.chat-item.active{
    background:#eef2ff;
    border-left:4px solid #4f46e5;
}

/* ===== PANEL DERECHO ===== */
.chat-content{
    flex:1;
    display:flex;
    flex-direction:column;
    background:#f1f5f9;
}

/* ===== HEADER CHAT ===== */
.top-bar{
    padding:18px 30px;
    display:flex;
    align-items:center;
    gap:15px;
    background:#ffffff;
    border-bottom:1px solid #e5e7eb;
}

.top-pfp{
    width:45px;
    height:45px;
    border-radius:50%;
    box-shadow:0 4px 10px rgba(0,0,0,0.1);
}

/* ===== MENSAJES ===== */
.messages-area{
    flex:1;
    padding:35px;
    overflow-y:auto;
    display:flex;
    flex-direction:column;
    gap:14px;
}

.msg-bubble{
    max-width:60%;
    padding:14px 16px;
    font-size:14px;
    border-radius:18px;
    display:flex;
    flex-direction:column;
    box-shadow:0 8px 20px rgba(0,0,0,0.05);
    animation:fadeIn .25s ease;
}

@keyframes fadeIn{
    from{opacity:0;transform:translateY(5px)}
    to{opacity:1;transform:translateY(0)}
}

.msg-received{
    background:#ffffff;
    align-self:flex-start;
    border-bottom-left-radius:6px;
}

.msg-sent{
    background:linear-gradient(135deg,#4f46e5,#6366f1);
    color:#ffffff;
    align-self:flex-end;
    border-bottom-right-radius:6px;
}

.msg-image{
    width:100%;
    max-width:300px;
    border-radius:12px;
    cursor:pointer;
    margin-bottom:8px;
}

/* ===== INPUT ===== */
.input-area{
    padding:18px 25px;
    display:flex;
    align-items:center;
    gap:12px;
    background:#ffffff;
    border-top:1px solid #e5e7eb;
    position:relative;
}

.input-area input[type="text"]{
    flex:1;
    background:#f1f5f9;
    border:none;
    padding:14px 18px;
    border-radius:14px;
    font-family:'Montserrat';
    outline:none;
    transition:all .2s ease;
}

.input-area input[type="text"]:focus{
    background:#ffffff;
    box-shadow:0 0 0 2px #6366f1;
}

.icon-btn{
    color:#64748b;
    font-size:20px;
    cursor:pointer;
    transition:.2s;
}

.icon-btn:hover{
    color:#4f46e5;
    transform:scale(1.1);
}

.send-btn{
    background:linear-gradient(135deg,#4f46e5,#6366f1);
    color:#fff;
    width:42px;
    height:42px;
    border-radius:12px;
    display:flex;
    align-items:center;
    justify-content:center;
    cursor:pointer;
    transition:.2s;
}

.send-btn:hover{
    transform:scale(1.05);
}

/* ===== MODAL PREVIEW ===== */
#media-preview-modal{
    position:fixed;
    top:0;
    left:0;
    width:100%;
    height:100%;
    background:rgba(15,23,42,0.85);
    backdrop-filter:blur(12px);
    z-index:1000;
    display:none;
    flex-direction:column;
}

.preview-body{
    flex:1;
    display:flex;
    flex-wrap:wrap;
    justify-content:center;
    align-items:center;
    padding:30px;
    gap:20px;
}

.img-preview-thumb{
    height:220px;
    border-radius:14px;
    box-shadow:0 10px 25px rgba(0,0,0,0.3);
}

.preview-footer{
    padding:30px;
    background:#ffffff;
    display:flex;
    flex-direction:column;
    align-items:center;
    gap:18px;
}

.preview-footer input{
    width:100%;
    max-width:800px;
    padding:16px;
    border:none;
    border-radius:14px;
    background:#f1f5f9;
}

.wa-send-circle{
    background:linear-gradient(135deg,#4f46e5,#6366f1);
    color:#fff;
    width:65px;
    height:65px;
    border-radius:18px;
    display:flex;
    align-items:center;
    justify-content:center;
    cursor:pointer;
    font-size:24px;
    transition:.2s;
}

.wa-send-circle:hover{
    transform:scale(1.05);
}
</style>
</head>
<body>
<div class="sidebar-redes">
    <div class="red-icon"><img src="https://upload.wikimedia.org/wikipedia/commons/6/6b/WhatsApp.svg"></div>
    <div class="red-icon"><img src="https://upload.wikimedia.org/wikipedia/commons/e/e7/Instagram_logo_2016.svg"></div>
    <div style="margin-top:auto;padding-bottom:25px;font-weight:700;font-size:11px;color:#8a8d91">S/380</div>
</div>
<div class="chat-list-container">
    <div class="list-header">Mensajes</div>
    <div class="chat-list" id="chat-list"></div>
</div>
<div class="chat-content">
    <div class="top-bar">
        <img id="header-pic" src="https://via.placeholder.com/42" class="top-pfp">
        <div id="header-name" style="font-weight:700">Selecciona un chat</div>
    </div>
    <div class="messages-area" id="messages"></div>
    <div class="input-area">
        <div id="emoji-picker-container"></div>
        <i class="fa-regular fa-face-smile icon-btn" id="emoji-trigger"></i>
        <label for="file-input"><i class="fa-solid fa-paperclip icon-btn"></i></label>
        <input type="file" id="file-input" style="display:none" accept="image/*" multiple>
        <input type="text" id="message-input" placeholder="Escribe un mensaje" autocomplete="off">
        <div class="send-btn" onclick="sendMessage()"><i class="fa-solid fa-paper-plane"></i></div>
    </div>
</div>

<div id="media-preview-modal">
    <div style="padding:20px"><i class="fa-solid fa-xmark icon-btn" onclick="closePreview()"></i></div>
    <div class="preview-body" id="preview-container"></div>
    <div class="preview-footer">
        <input type="text" id="preview-caption" style="width:100%;max-width:800px;padding:15px;border:none;border-radius:8px" placeholder="AÃ±ade un comentario...">
        <div style="width:100%;max-width:800px;display:flex;justify-content:flex-end">
            <div class="wa-send-circle" onclick="submitMedia()"><i class="fa-solid fa-paper-plane"></i></div>
        </div>
    </div>
</div>

<script>
let currentChat=null; let chats={}; let filesToUpload=[];
const ws=new WebSocket(`${location.protocol==="https:"?"wss:":"ws:"}//${location.host}`);

const pickerOptions = { onEmojiSelect: (emoji) => { document.getElementById('message-input').value += emoji.native; }, locale: 'es', theme: 'light' }
const picker = new EmojiMart.Picker(pickerOptions);
document.getElementById('emoji-picker-container').appendChild(picker);

const emojiTrigger = document.getElementById('emoji-trigger');
const emojiContainer = document.getElementById('emoji-picker-container');

emojiTrigger.onclick = (e) => {
    e.stopPropagation();
    emojiContainer.style.display = emojiContainer.style.display === 'block' ? 'none' : 'block';
};

document.addEventListener('click', (e) => {
    if (!emojiContainer.contains(e.target) && e.target !== emojiTrigger) {
        emojiContainer.style.display = 'none';
    }
});

ws.onmessage=(event)=>{
  const msg=JSON.parse(event.data);
  if(msg.type==="incoming"){
    createOrUpdateChat(msg.data,true);
    if(currentChat===msg.data.from) appendMessage("received",msg.data.text,msg.data.mediaUrl);
  } else if(msg.type==="sent"){
    // Se asegura de mostrarlo si el destinatario es el chat actual
    if(currentChat===msg.data.to) appendMessage("sent",msg.data.text,msg.data.mediaUrl);
  }
};

function createOrUpdateChat(data,isNew){
  const id=data.from || data.chatId;
  const name=data.pushname || chats[id]?.name || id;
  chats[id]={name};
  let item=document.getElementById("chat-"+id);
  if(!item){
    item=document.createElement("div"); item.className="chat-item"; item.id="chat-"+id;
    item.onclick=()=>openChat(id); document.getElementById("chat-list").prepend(item);
  }
  item.innerHTML=`<img src="https://ui-avatars.com/api/?name=${name}" style="width:45px;border-radius:50%">
    <div style="flex:1"><b>${name}</b><br><small>${data.text || "ðŸ“· Imagen"}</small></div>`;
  if(isNew) document.getElementById("chat-list").prepend(item);
}

async function openChat(id){
  currentChat=id; document.getElementById("header-name").innerText=chats[id].name;
  document.querySelectorAll('.chat-item').forEach(el=>el.classList.remove('active'));
  document.getElementById("chat-"+id).classList.add('active');
  const res=await fetch(`/chat/messages/${id}`);
  const msgs=await res.json(); document.getElementById("messages").innerHTML="";
  msgs.forEach(m=>appendMessage(m.from==="me"?"sent":"received",m.text,m.mediaUrl));
}

function appendMessage(type,text,mediaUrl){
  const div=document.createElement("div"); div.className="msg-bubble "+(type==="sent"?"msg-sent":"msg-received");
  if(mediaUrl) div.innerHTML+=`<img src="${mediaUrl}" class="msg-image" onclick="window.open('${mediaUrl}')">`;
  if(text) div.innerHTML+=`<div>${text}</div>`;
  document.getElementById("messages").appendChild(div);
  document.getElementById("messages").scrollTop=document.getElementById("messages").scrollHeight;
}

async function sendMessage(){
  const input=document.getElementById("message-input"); const text=input.value.trim();
  if(!text || !currentChat) return; input.value="";
  await fetch("/send-message",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({to:currentChat,text})});
}

document.getElementById('file-input').onchange=function(){
    if(!this.files.length||!currentChat)return;
    filesToUpload=Array.from(this.files);
    const container=document.getElementById('preview-container'); container.innerHTML='';
    filesToUpload.forEach(f=>{
        const img=document.createElement('img'); img.src=URL.createObjectURL(f); img.className='img-preview-thumb';
        container.appendChild(img);
    });
    document.getElementById('media-preview-modal').style.display='flex';
};

function closePreview(){ document.getElementById('media-preview-modal').style.display='none'; filesToUpload=[] }

async function submitMedia(){
    const caption=document.getElementById('preview-caption').value.trim();
    const target=currentChat; const files=[...filesToUpload]; closePreview();
    if(caption) await fetch("/send-message",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({to:target,text:caption})});
    for(let f of files){
        const fd=new FormData(); fd.append("file",f); fd.append("to",target);
        await fetch("/send-media",{method:"POST",body:fd});
    }
}

window.onload=async()=>{
  const res=await fetch("/chat/list"); const list=await res.json();
  list.reverse().forEach(c=>createOrUpdateChat({chatId:c._id,pushname:c.pushname,text:c.text},false));
};
document.getElementById("message-input").addEventListener("keypress",(e)=>{if(e.key==='Enter')sendMessage()});
</script>
</body>
</html>